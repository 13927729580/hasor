#RSF-Center

&emsp;&emsp;RSF注册中心，目的是维护一个RSF服务列表，并为所有连接到注册中心上的RSF客户端提供服务的发布和订阅支持。

&emsp;&emsp;本文是RSF注册中心“服务发现”模块的技术文档。服务中心是一组后台服务，它是整个RSF注册中心的核心，它负责接收来自RSF客户端的请求。处理应用上线、下线、服务发布、服务订阅。同时也负责维护客户端心跳，必要时候服务中心还会更新服务在线状态。因此我们可以看到服务的发布、订阅和心跳检测功能都是在这里。配置推送指的是服务路由策略的推送。

&emsp;&emsp;RSF中心和RSF客户端，的通讯采用长轮询（Long-Polling）方式。客户端发起一个长连接请求并同时携带上一次请求时标识ID，如果服务器端发现在这个标识ID之后曾经发生了数据变动那么就把最新的数据返回给客户端（全量数据），尚若服务器发现没有数据变化，那么持有这个连接 30 秒。在持有连接的过程中如果有数据发生变化，注册中心要及时的反馈数据给客户端。

&emsp;&emsp;每当注册中心把数据响应给客户端之后都要把连接关闭，等待下一次客户端发来请求。通过这种方式RSF客户端和服务器之间可以达到实时同步数据的目的。之所以这样设计是因为考虑到实际生产环境中服务器的上下线不会很频繁。而且这种设计很小巧切满足功能需要，同时也不需要引入 zookeeper 这样的大家伙。
·
##一、架构设计
###数据分层
1. 持久层：MySQL or HSQL持久化存储，前者用于`Server`模式，后者运行在`standalone`模式下。
2. 检索层：通过`Lucene实时索引`方式同步持久层数据变更，客户端所有订阅发都查询自Lucene索引。

###Lucene索引
1. 所有数据的（`增、删、改`）操作都先对`持久层`进行操作，当操作成功之后再同步操作到Lucene。如发生异常，则
2. 重建索引，系统设定一个更新阀值，当达到这个临界点时。重新建立一个索引把所有更改都同步到一个新索引中。

###长轮询
1. 长轮询主要用于心跳检测和数据推送。
2. 




##二、模块设计
###查询中心
>&emsp;&emsp;查询中心包含两个页面，一个是 list 页另一个是 detail页。在 list 页里开发者可以通过（应用名、服务分组名、服务名称、客户端IP）这些信息来查询在线的RSF服务。所有符合条件的RSF服务都会被列出来，当然页面是要有分页的。点击其中一条数据就可以进入服务详情页（与应用注册中的详情页共享）在这个页面中会罗列出，这个服务的 owner，所属应用，接口人，服务名字，服务分组，服务版本，提供者列表、消费者列表等信息。

###测试中心
>&emsp;&emsp;测试中心是一个附加的系统，它的优先级和监控中心一样都比较低。测试中心是为开发联调环节提供一个强有力的工具。开发者可以在使用某个接口之前通过在线的方式直接加以测试，当然开发者也可以使用测试中心直接调试自己的服务程序。在测试中心发起API测试调用时，可以选择是否指定IP，这个对开发调试接口是十分有用的功能。

##数据表
###HSQL